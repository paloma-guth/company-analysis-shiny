---
title: "Companies analysis"
output: 
  flexdashboard::flex_dashboard:
<<<<<<< HEAD
    orientation: columns
    vertical_layout: fill 
=======
    orientation: rows
    vertical_layout: scroll
    theme: 
      version: 4
      bootswatch: minty
>>>>>>> 89e22ed082a88ebc6370200c8b635d7fe9ebd164
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(ggplot2)
library(dplyr)
library(readr)
library(leaflet)
library(grid)
library(tidyverse)
library(shadowtext)
<<<<<<< HEAD
library(forcats)

current_ratio_tidy <- read.csv("current_ratio_tidy.csv")
return_on_assets_tidy <- read_csv("return_on_assets_tidy.csv")
debt_ratio_tidy <- read_csv("debt_ratio_tidy.csv")
all_headlines_tidy <- read_csv("all_headlines_tidy.csv")
companies_hq <- read_csv("companies_hq.csv")
all_balance_data <- read_csv("debt_analysis.csv")
all_income_data <- read_csv("revenue_anlysis.csv")



#get_top_words <- function(data, company, year, n = 5) {
 # data %>%
#    filter(company == company, year == year) %>%
#    count(word, sort = TRUE) %>%
#    top_n(n, n) %>%
#    arrange(desc(n))
#}

all_balance_data <- read_csv("debt_analysis.csv")

# Summarize the balance sheet data
summarized_balance_data <- all_balance_data %>%
  group_by(company) %>%
  summarise(across(c(total_current_assets, total_debt, total_liabilities, shareholders_equity), sum, na.rm = TRUE)) %>%
  pivot_longer(cols = c(total_current_assets, total_debt, total_liabilities, shareholders_equity),
               names_to = "variable",
               values_to = "value")

generate_balance_plot <- function(data, selected_company) {
  filtered_data <- data %>% filter(company == selected_company)
  ggplot(filtered_data, aes(x = variable, y = value, fill = variable)) +
    geom_bar(stat = "identity", position = "dodge") +
    labs(title = paste("Summary of Balance Sheet for", selected_company),
         x = "Balance Sheet Item", y = "Summed Value") +
    theme_minimal()
}
=======
library(plotly)
library(gganimate)
library(orca)

current_ratio_tidy <- read.csv("current_ratio_tidy2.csv")
return_on_assets_tidy <- read_csv("return_on_assets_tidy2.csv")
debt_ratio_tidy <- read_csv("debt_ratio_tidy2.csv")
all_headlines_tidy <- read_csv("all_headlines_tidy2.csv")
companies_hq <- read_csv("companies_hq2.csv")
revenue_tidy<-read.csv("revenue_tidy2.csv")

>>>>>>> 89e22ed082a88ebc6370200c8b635d7fe9ebd164
#everything is in millions USD
#Fiscal year is January - December

m <- list(
  l = 50,
  r = 50,
  b = 50,
  t = 50
  )

sector_mapping <- list("All" = "All", 
                     "Technology" = "internet_content", 
                     "Entertainment" = "entertainment",
                     "Healthcare" = "health_plan",
                     "Automobile Manufactures" = "auto_manufactures",
                     "Farm Products" = "farm_products")

pallete<-c('#003924', '#0f543c', '#1f7057', '#338d72', '#52aa8e', '#71c8ab', '#a7e2ce', 'darkgray', '#ffdac4', '#ffb3a7', '#fb8a8c', '#eb6574', '#d5405e', '#b81b4a', '#93003a')

```

Introduction
==========================

Row {data-height=100 }
-------------------------------------

### Analysis Overview

This analysis examines companies from five sectors: technology, entertainment, healthcare, automobile manufacturers, and farm products. Each sector is represented by three companies. We analyzed their balance sheets and income statements, with all data based on a fiscal year running from January to December.

Row 
-------------------------------------

### Companies geolocation

```{r}
leaflet(companies_hq) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%  # Change the map style
  addCircleMarkers(
    data = companies_hq,
    lat = ~latitude,
    lng = ~longitude,
    radius = ~sqrt(revenue) / 100, # Resize
    color = "#FFC20C",  # Set marker color
    fillOpacity = 0.5,  # Adjust marker opacity
    stroke = FALSE,  # Remove marker stroke
    popup = ~paste0("<b>Company:</b> ", company, "<br>",
                    "<b>Address:</b> ", address, "<br>",
                    "<b>Revenue:</b> $", format(revenue, big.mark = ","))
  ) %>%
  addLegend(  # Add legend for marker size
    position = "bottomright",
    colors = "#FFC20C",
    labels = c("Revenue"),
    title = "Marker Size",
    opacity = 1
  )

```


Economical analysis
==========================

Inputs {.sidebar}
-------------------------------------
```{r}
inputPanel(
  selectInput("sector1", 
              label = "Select Sector:", 
              choices = c("All", "Technology", "Entertainment", "Healthcare", "Automobile Manufactures", "Farm Products")),
  uiOutput("company_select")
)
```

Explain about sectors and each ratio/analysis

Row {.tabset .tabset-fade}
-------------------------
### Current Ratio

```{r}

renderPlotly({
  filtered_data <- current_ratio_tidy
  
  selected_sector_column <- sector_mapping[input$sector1] 
  
  if (selected_sector_column != "All") {
    filtered_data <- filtered_data |>
      filter(sector==selected_sector_column)  # Filter using the selected column
  }
  
  filtered_data$year <- as.factor(filtered_data$year)
  
  fig <- filtered_data|>
    plot_ly( x = ~year,
            y = ~debt_ratio, 
            color = ~fct_reorder2(company, year, debt_ratio),
            colors = pallete,
            type = 'scatter', 
            mode = 'lines+markers', 
            text = ~paste(company, ", ", year, "<br>", "Debt Ratio: ", round(debt_ratio, 2)), 
            hoverinfo = 'text', 
            width = 890, 
            height = 400) |>
    layout( title = "Debt Ratio by Company Over Time",
      yaxis = list(
        title = "Debt Ratio",
        zeroline = FALSE,
        tickprefix = "",
        margin=m),
      xaxis = list(
        title = "Year",
        zeroline = FALSE,
        showgrid = FALSE,
        tickangle = 45
      ),
      legend = list(
        title = list(text = "Companies")
      )
    )
  
  fig
})
```


### Debt ratio

```{r}
renderPlotly({
  filtered_data <- debt_ratio_tidy
  
  selected_sector_column <- sector_mapping[input$sector1] 
  
  if (selected_sector_column != "All") {
    filtered_data <- filtered_data |>
      filter(sector==selected_sector_column)  # Filter using the selected column
  }
  
  filtered_data$year <- as.factor(filtered_data$year)
  
  fig2 <- filtered_data|>
    plot_ly( x = ~year,
            y = ~debt_ratio, 
            color = ~fct_reorder2(company, year, debt_ratio),
            colors = pallete,
            type = 'scatter', 
            mode = 'lines+markers', 
            text = ~paste(company, ", ", year, "<br>", "Debt Ratio: ", round(debt_ratio, 2)), 
            hoverinfo = 'text', 
            width = 890, 
            height = 400) |>
    layout( title = "Debt Ratio by Company Over Time",
      yaxis = list(
        title = "Debt Ratio",
        zeroline = FALSE,
        tickprefix = "",
        margin=m),
      xaxis = list(
        title = "Year",
        zeroline = FALSE,
        showgrid = FALSE,
        tickangle = 45
      ),
      legend = list(
        title = list(text = "Companies")
      )
    )
  
  fig2
})
```

### Return on Assets

```{r}
renderPlotly({
  filtered_data <- return_on_assets_tidy
  
  selected_sector_column <- sector_mapping[input$sector1] 
  
  if (selected_sector_column != "All") {
    filtered_data <- filtered_data |>
      filter(sector==selected_sector_column)  # Filter using the selected column
  }
  
  filtered_data$year <- as.factor(filtered_data$year)
  
  fig3 <- filtered_data|>
    plot_ly( x = ~year,
            y = ~debt_ratio, 
            color = ~fct_reorder2(company, year, debt_ratio),
            colors = pallete,
            type = 'scatter', 
            mode = 'lines+markers', 
            text = ~paste(company, ", ", year, "<br>", "Debt Ratio: ", round(debt_ratio, 2)), 
            hoverinfo = 'text', 
            width = 890, 
            height = 400) |>
    layout( title = "Debt Ratio by Company Over Time",
      yaxis = list(
        title = "Debt Ratio",
        zeroline = FALSE,
        tickprefix = "",
        margin=m),
      xaxis = list(
        title = "Year",
        zeroline = FALSE,
        showgrid = FALSE,
        tickangle = 45
      ),
      legend = list(
        title = list(text = "Companies")
      )
    )
  
  fig3
})
```

News headlines
==========================

Row {data-height=190}
-------------------------------------

### New York Times API

This analysis is based on headlines from The New York Times, collected using their API for the period from 2014 to 2023. This time range was chosen to align with the available data for the economic analysis, balance sheet, and income statement. Since The New York Times is a U.S.-based publication, the analysis includes companies with significant U.S. or global influence. Therefore, some influential non-U.S. companies like Toyota are included, while others that are less relevant to U.S. readers may not be.It is important to note that some major companies, such as Meta and Google, may not appear in this analysis. This absence could be due to the headlines not explicitly mentioning the companies' names, despite The New York Times possibly covering news about them. The specific phrasing of headlines can result in the exclusion of certain companies from the dataset.

Row {data-height=650}
-------------------------------------

### Average Sentiment Trends by Company

```{r}
inputPanel(
  selectInput("year", label = "Select Year:", choices = unique(all_headlines_tidy$year))
)
```

```{r fig.height=700, fig.width=700}
renderPlot({
  filtered_data <- all_headlines_tidy %>% filter(year == input$year)
  sentiment_by_company <- filtered_data %>%
    group_by(company, year) %>%
    summarise(
      avg_sentiment = mean(value, na.rm = TRUE),
      sd_sentiment = sd(value, na.rm = TRUE) / sqrt(n())
    )
  
  ggplot(sentiment_by_company, aes(x = company, y = avg_sentiment, fill = avg_sentiment)) +
    geom_bar(stat = "identity") +
    geom_errorbar(aes(ymin = avg_sentiment - sd_sentiment, ymax = avg_sentiment + sd_sentiment), width = 0.2) +
    scale_fill_gradient2(low = "#73CAAC", mid = "gray", high = "#E4B559", midpoint = 0) +
    theme_minimal() +
    labs(title = "", x= "Company", y= "Average Sentiment", fill = "Sentiment \n score") +
    coord_flip()
}, height = 500, width = 550)
```

### Top 5 Words by Company and Year

```{r}
inputPanel(
  selectInput("year2", label = "Select Year:", choices = unique(all_headlines_tidy$year)),
  selectInput("company2", label = "Select Company:", choices = unique(all_headlines_tidy$company))
)
```

```{r fig.height=400, fig.width=600}
renderPlot({
  
  filtered_data <- all_headlines_tidy %>%
    filter(company == input$company2, year == input$year2)
  
  top_words <- filtered_data %>%
    group_by(word) %>%
    summarise(
      occurrences = n(),
      avg_value = mean(value)
    ) %>%
    arrange(desc(occurrences)) %>%
    slice_head(n = 5)
  
  ggplot(top_words, aes(x = reorder(word, occurrences), y = avg_value, fill = avg_value)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = word),position = position_stack(vjust= 0.5), colour = "white") + 
    theme_minimal()  +
    theme(axis.text.y = element_blank()) +
    scale_fill_gradient2(low = "#73CAAC", mid = "gray", high = "#E4B559", midpoint = 0) +
    labs(title = "", x = "", y = "", fill="Sentiment \n score") +
    coord_flip()
<<<<<<< HEAD
})
```



Column
-----------------------------------------------------------------------



Debt Analysis
==========================
Text

Row {.tabset .tabset-fade}
-------------------------
### Summary of Balance Sheet


```{r}
all_balance_data <- read_csv("debt_analysis.csv")

summarized_balance_data <- all_balance_data %>%
  group_by(company) %>%
  summarise(across(c(total_current_assets, total_debt, total_liabilities, shareholders_equity), sum, na.rm = TRUE)) %>%
  pivot_longer(cols = c(total_current_assets, total_debt, total_liabilities, shareholders_equity),
               names_to = "variable",
               values_to = "value")

generate_balance_plot <- function(data, selected_company) {
  filtered_data <- data %>% filter(company == selected_company)
  ggplot(filtered_data, aes(x = variable, y = value, fill = variable)) +
    geom_bar(stat = "identity", position = "dodge") +
    labs(title = paste("Summary of Balance Sheet for", selected_company),
         x = "Balance Sheet Item", y = "Summed Value") +
    theme_minimal()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          plot.margin = margin(t = 40, r = 40, b = 70, l = 40))
  
}

```



```{r}
inputPanel(
  selectInput("selected_company", "Select Company:", choices = unique(summarized_balance_data$company))
)

renderPlot({
  req(input$selected_company) # Ensure the input is available
  generate_balance_plot(summarized_balance_data, input$selected_company)
})

```



```{r}
all_income_data <- read_csv("revenue_analysis.csv")

summarized_income_data <- all_income_data %>%
  group_by(company) %>%
  summarise(across(c(revenue, gross_profit, operating_income, ebit), sum, na.rm = TRUE)) %>%
  pivot_longer(cols = c(revenue, gross_profit, operating_income, ebit),
               names_to = "variable",
               values_to = "value")

generate_income_plot <- function(data, selected_company) {
  filtered_data <- data %>% filter(company == selected_company)
  ggplot(filtered_data, aes(x = variable, y = value, fill = variable)) +
    geom_bar(stat = "identity", position = "dodge") +
    labs(title = paste("Summary of Income Statement for", selected_company),
         x = "Income Statement Item", y = "Summed Value") +
    theme_minimal()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1), 
          plot.margin = margin(t = 40, r = 40, b = 70, l = 40))}

```




### Summary of Income Statement

```{r}
inputPanel(
  selectInput("selected_company_income", "Select Company:", choices = unique(summarized_income_data$company))
)

renderPlot({
  req(input$selected_company_income) # Ensure the input is available
  generate_income_plot(summarized_income_data, input$selected_company_income)
})


```


=======
}, height = 500, width = 550)
```


Final Consideration
==========================

#### Limitations

This analysis has a few key limitations. Firstly, it relies on news headlines from the U.S., collected via the New York Times API, which may result in a U.S.-centric perspective. Secondly, the financial data available for the analysis covers a limited time span of nine years. Additionally, we encountered challenges with the API, such as request limits, which restricted the volume of data we could retrieve.

#### Conclusion

This comprehensive analysis combines financial data with sentiment analysis to offer a multi-faceted view of each company's performance and public image. By examining both quantitative and qualitative aspects, we aim to provide valuable insights into the current state and future prospects of these companies within their respective sectors.

#### Sources
- New York Times API
- List of All Stock Ticker Symbols - Stock Analysis. (n.d.). Stock Analysis. https://stockanalysis.com/stocks

Students: Paloma Guth Kronbauer and Zumratmo Zarifkhonova
>>>>>>> 89e22ed082a88ebc6370200c8b635d7fe9ebd164

